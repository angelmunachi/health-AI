<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LimbScan AI</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/PWA/manifest.json" />
  <meta name="theme-color" content="#020617" />

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    header {
      padding: 1rem;
      background: #020617;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 600;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
    }

    .panel {
      background: #020617;
      border-radius: 10px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    input[type="file"] {
      padding: 0.3rem;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #1d4ed8;
    }

    #result {
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
      flex: 1;
      overflow-y: auto;
    }

    #three-container {
      width: 100%;
      height: 350px;
      border-radius: 8px;
      overflow: hidden;
      background: #0f172a;
    }

    footer {
      padding: 0.8rem;
      text-align: center;
      font-size: 0.75rem;
      color: #94a3b8;
    }

    @media (max-width: 768px) {
      main {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>LimbScan AI â€” Visual Health Awareness</header>

  <main>
    <!-- Upload Panel -->
    <div class="panel">
      <h3>Upload Leg Image</h3>
      <input type="file" id="imageInput" accept="image/*" />
      <button onclick="analyzeImage()">Analyze</button>

      <h3>AI Observations</h3>
      <div id="result">No analysis yet.</div>
    </div>

    <!-- 3D Visual Panel -->
    <div class="panel">
      <h3>Visual Insight</h3>
      <div id="three-container"></div>
    </div>
  </main>

  <footer>
    This tool provides general visual observations only and does not diagnose medical conditions.
  </footer>

  <script>
    let scene, camera, renderer, markers = [];

    function initThree() {
      const container = document.getElementById("three-container");

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x020617);

      camera = new THREE.PerspectiveCamera(
        60,
        container.clientWidth / container.clientHeight,
        0.1,
        1000
      );
      camera.position.z = 5;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);

      const geometry = new THREE.PlaneGeometry(4, 6);
      const material = new THREE.MeshBasicMaterial({
        color: 0x1e293b,
        wireframe: true
      });
      scene.add(new THREE.Mesh(geometry, material));

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function clearMarkers() {
      markers.forEach(m => scene.remove(m));
      markers = [];
    }

    function addMarker(x, y, risk) {
      const colors = {
        low: 0x22c55e,
        medium: 0xfacc15,
        unclear: 0xf97316
      };

      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(0.08, 16, 16),
        new THREE.MeshBasicMaterial({ color: colors[risk] || 0x94a3b8 })
      );

      sphere.position.set((x - 0.5) * 4, (0.5 - y) * 6, 0.1);
      scene.add(sphere);
      markers.push(sphere);
    }

    async function analyzeImage() {
      const input = document.getElementById("imageInput");
      const resultBox = document.getElementById("result");

      if (!input.files.length) return;

      clearMarkers();
      resultBox.textContent = "Analyzing image...";

      const formData = new FormData();
      formData.append("file", input.files[0]);

      try {
        const response = await fetch("/api/analyze-leg", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          throw new Error("Server error: " + response.status);
        }

        const json = await response.json();
        const analysis = json.data.analysis;

        resultBox.textContent =
          "AI Observations:\n\n" +
          (analysis.observations || "No visible issues detected.") +
          "\n\nRisk Level: " +
          (analysis.risk_level || "UNCLEAR").toUpperCase();

        if (Array.isArray(analysis.visual_markers)) {
          analysis.visual_markers.forEach(m => {
            addMarker(m.x, m.y, analysis.risk_level);
          });
        }

      } catch (err) {
        resultBox.textContent = "Error analyzing image: " + err.message;
      }
    }

    initThree();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/PWA/service-worker.js")
        .catch(() => {});
    }
  </script>
</body>
</html>
